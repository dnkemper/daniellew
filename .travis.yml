language: php
os: linux
dist: focal
php: '8.1'
env:
  global:
  - COMPOSER_BIN=$TRAVIS_BUILD_DIR/vendor/bin
  - BLT_TRAVIS_DIR=$TRAVIS_BUILD_DIR/vendor/acquia/blt-travis
  - PERCY_POSTINSTALL_BROWSER=true
cache:
  directories:
  - "$TRAVIS_BUILD_DIR/node_modules/"
  - "web/themes/custom/olympian/node_modules"
services:
- mysql

addons:
  chrome: stable
  ssh_known_hosts:
  - drupaladm@artscidev.wustl.edu
  - drupaladm@artscistage.wustl.edu
  - drupaladm@artsciprod.wustl.edu

# @see https://docs.travis-ci.com/user/notifications
# notifications:
#   - hipchat: [api token]@[room id or name]
#   - slack: '<account>:<token>#[channel]'

before_install:
  # Disable xdebug.
  - phpenv config-rm xdebug.ini
  - composer self-update
  - composer install
  # Exit build early if only documentation was changed in a Pull Request.
  - source ${BLT_TRAVIS_DIR}/scripts/exit_early

install:
- nvm install
- nvm use
- yarn --version
- composer install
- source ${BLT_TRAVIS_DIR}/scripts/exit_early
- source ${BLT_TRAVIS_DIR}/scripts/setup_environment
- source ${BLT_TRAVIS_DIR}/scripts/setup_project
script:
- blt blt:telemetry:disable --no-interaction
- source ${BLT_TRAVIS_DIR}/scripts/run_tests
- rm LICENSE.chromedriver
  # Uncomment these lines to test database updates using live content.
  # - blt drupal:sync:default:site
  # - source ${BLT_TRAVIS_DIR}/scripts/run_tests
  # - source ${BLT_TRAVIS_DIR}/scripts/simulate_deploy
deploy:
- provider: script
  script: "${BLT_TRAVIS_DIR}/scripts/deploy_branch"
  skip_cleanup: true
  on:
    branch: develop
    php: 8.1
- provider: script
  script: "${BLT_TRAVIS_DIR}/scripts/deploy_branch"
  skip_cleanup: true
  on:
    branch: main
    php: 8.1
- provider: script
  script: "${BLT_TRAVIS_DIR}/scripts/deploy_tag"
  skip_cleanup: true
  on:
    tags: true
    php: 8.1
